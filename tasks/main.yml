---
- name: add users
  with_items:
    - "{{ users }}"
  user: name={{ item.name }} password={{ item.password }} state=present shell=/bin/bash
  no_log: true
  when: item.name in authorized

- name: remove users
  with_items:
    - "{{ users }}"
  user: name={{ item.name }} password={{ item.password }} state=absent shell=/bin/bash
  no_log: true
  when: item.name not in authorized

- name: add SSH public keys to users
  with_items: "{{ users }}"
  authorized_key: user={{ item.name }} key={{ item.key }}
  no_log: true
  when: item.name in authorized

- name: add users to sudoers
  with_items: "{{ users }}"
  lineinfile:
    "dest=/etc/sudoers
    regexp='^{{ item.name }} ALL'
    line='{{ item.name }} ALL=(ALL) NOPASSWD: ALL'
    state=present"
  no_log: true
  when: item.name in authorized and item.name in promoted
